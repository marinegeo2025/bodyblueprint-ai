<script>
  // Handle form submission
  document.getElementById("weightForm").addEventListener("submit", function (event) {
    event.preventDefault();
    
    const weight = parseFloat(document.getElementById("weightInput").value);
    const notes = document.getElementById("notes").value;
    let dateVal = document.getElementById("dateInput").value;
    // If user didn't pick a date, default to today's date
    if (!dateVal) {
      dateVal = new Date().toISOString().split("T")[0];
    }

    let weightData = JSON.parse(localStorage.getItem("weightData")) || [];
    // Append new weight entry
    weightData.push({ date: dateVal, weight, notes });
    localStorage.setItem("weightData", JSON.stringify(weightData));

    // Reset form fields
    document.getElementById("weightInput").value = "";
    document.getElementById("notes").value = "";
    document.getElementById("dateInput").value = "";

    updateWeightTable();
    updateChart();
  });

  // Render the table with each weight entry in its own row (with a delete button)
  window.updateWeightTable = function() {
    const tbody = document.querySelector("#weightTable tbody");
    tbody.innerHTML = "";

    let weightData = JSON.parse(localStorage.getItem("weightData")) || [];
    // Sort entries by date ascending
    weightData.sort((a, b) => new Date(a.date) - new Date(b.date));

    weightData.forEach((entry, index) => {
      const row = document.createElement("tr");

      // Date cell with editable input
      const dateCell = document.createElement("td");
      const dateInput = document.createElement("input");
      dateInput.type = "date";
      dateInput.value = entry.date;
      dateInput.addEventListener("change", () => {
        weightData[index].date = dateInput.value;
        localStorage.setItem("weightData", JSON.stringify(weightData));
        updateWeightTable();
        updateChart();
      });
      dateCell.appendChild(dateInput);
      row.appendChild(dateCell);

      // Weight cell
      const weightCell = document.createElement("td");
      weightCell.textContent = entry.weight;
      row.appendChild(weightCell);

      // Weekly average cell
      const weeklyAvgCell = document.createElement("td");
      // Calculate average for entries on the same date
      const sameDateEntries = weightData.filter(e => e.date === entry.date);
      let avgForDate = sameDateEntries.reduce((acc, e) => acc + e.weight, 0) / sameDateEntries.length;
      weeklyAvgCell.textContent = avgForDate.toFixed(1);
      row.appendChild(weeklyAvgCell);

      // Notes cell
      const notesCell = document.createElement("td");
      notesCell.textContent = entry.notes || "";
      row.appendChild(notesCell);

      // Delete button cell
      const deleteCell = document.createElement("td");
      const deleteButton = document.createElement("button");
      deleteButton.textContent = "X";
      deleteButton.style.color = "red";
      deleteButton.style.cursor = "pointer";
      deleteButton.title = "Delete this entry";
      deleteButton.addEventListener("click", () => {
        if (confirm("Are you sure you want to delete this weight entry?")) {
          weightData.splice(index, 1);
          localStorage.setItem("weightData", JSON.stringify(weightData));
          updateWeightTable();
          updateChart();
        }
      });
      deleteCell.appendChild(deleteButton);
      row.appendChild(deleteCell);

      tbody.appendChild(row);
    });
  };

  // Build/update the chart with a time-based x-axis
  function updateChart() {
    let weightData = JSON.parse(localStorage.getItem("weightData")) || [];
    if (weightData.length === 0) return;

    // Sort by date ascending
    weightData.sort((a, b) => new Date(a.date) - new Date(b.date));

    // Identify earliest & latest dates
    const earliestDate = new Date(weightData[0].date);
    const latestDate   = new Date(weightData[weightData.length - 1].date);

    // Extend x-axis 1 month beyond the latest date
    const xAxisMax = new Date(latestDate);
    xAxisMax.setMonth(xAxisMax.getMonth() + 1);

    // Create a daily map of weights for the actual data
    const dailyMap = {};
    weightData.forEach(item => {
      if (!dailyMap[item.date]) {
        dailyMap[item.date] = [];
      }
      dailyMap[item.date].push(item.weight);
    });

    // Build an array of dates (from earliestDate to xAxisMax)
    let currentDay = new Date(earliestDate);
    const filledDates = [];
    while (currentDay <= xAxisMax) {
      filledDates.push(currentDay.toISOString().split("T")[0]);
      currentDay.setDate(currentDay.getDate() + 1);
    }

    // Build corresponding daily average weights (or null if no entry)
    let avgWeights = filledDates.map(date => {
      if (dailyMap[date]) {
        const sum = dailyMap[date].reduce((a, b) => a + b, 0);
        return (sum / dailyMap[date].length).toFixed(1);
      } else {
        return null;
      }
    });

    // Convert dates to DD-MM format for x-axis labels
    let formattedDates = filledDates.map(date => {
      let parts = date.split("-");
      return `${parts[2]}-${parts[1]}`;
    });

    // Generate a basic linear regression trendline for valid points
    function linearRegression(x, y) {
      let validX = [];
      let validY = [];
      y.forEach((val, i) => {
        if (val !== null) {
          validX.push(i);
          validY.push(parseFloat(val));
        }
      });
      if (validX.length < 2) return y;
      const n = validX.length;
      const sumX = validX.reduce((acc, v) => acc + v, 0);
      const sumY = validY.reduce((acc, v) => acc + v, 0);
      const sumXY = validX.reduce((acc, v, i) => acc + v * validY[i], 0);
      const sumX2 = validX.reduce((acc, v) => acc + v * v, 0);
      const slope = (n * sumXY - sumX * sumY) / (n * sumX2 - sumX * sumX);
      const intercept = (sumY - slope * sumX) / n;
      return filledDates.map((_, i) => slope * i + intercept);
    }

    const trendline = linearRegression(filledDates, avgWeights);

    // Destroy previous chart instance if exists
    const ctx = document.getElementById("weightChart").getContext("2d");
    if (window.myChart) {
      window.myChart.destroy();
    }

    window.myChart = new Chart(ctx, {
      type: "line",
      data: {
        labels: formattedDates,
        datasets: [
          {
            label: "Daily Avg Weight",
            data: avgWeights,
            borderColor: "blue",
            fill: false,
            pointStyle: "circle",
            pointRadius: 3,
            borderWidth: 2,
            spanGaps: false,
          },
          {
            label: "Trendline",
            data: trendline,
            borderColor: "red",
            borderDash: [5, 5],
            fill: false,
            borderWidth: 2,
            spanGaps: true,
          },
        ],
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          x: {
            type: "time",
            time: {
              unit: "day",
              displayFormats: {
                day: "dd-LL",
              },
            },
            min: earliestDate,
            max: xAxisMax,
            ticks: {
              autoSkip: true,
              maxRotation: 30,
              minRotation: 30,
            },
            grid: {
              display: true,
              color: "rgba(200, 200, 200, 0.5)",
            },
          },
          y: {
            ticks: {
              stepSize: 1,
              font: { size: 14 },
            },
            grid: {
              display: true,
              color: "rgba(180, 180, 180, 0.7)",
            },
          },
        },
      },
    });
  }

  // On page load, restore the table and chart
  window.onload = function () {
    updateWeightTable();
    updateChart();
  };

  // Reset button for weight data
  document.getElementById("resetWeightButton").addEventListener("click", function() {
    if (confirm("Are you sure you want to delete all weight data? This cannot be undone.")) {
      localStorage.removeItem("weightData");
      document.querySelector("#weightTable tbody").innerHTML = "";
      if (window.myChart) {
        window.myChart.destroy();
      }
      alert("Weight data has been cleared.");
    }
  });
</script>
