<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Êú¨Êù•„ÅÆÈù¢ÁõÆ, Honrai No Menmoku - Weight Tracking</title>
    <link rel="stylesheet" href="styles.css" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
      /* Make sure the chart container scales nicely */
      #weightChart {
        width: 100%;
        /* You can set a max-height if you like, e.g. 600px */
        max-height: 600px;
      }
      
      /* Simple responsive helper for the canvas container */
      .chart-container {
        position: relative;
        width: 100%;
        max-width: 800px; /* Adjust as desired */
        margin: 0 auto;   /* Center it */
      }
    </style>
  </head>

  <body>
    <nav>
      <ul>
        <li><a href="index.html">üè† Home</a></li>
        <li><a href="bmr.html">üèãÔ∏è BMR</a></li>
        <li><a href="weight.html">üìâ Weight</a></li>
        <li><a href="meals.html">üçΩÔ∏è Meals</a></li>
        <li><a href="chat.html">üí¨ AI Chat</a></li>
      </ul>
    </nav>

    <main>
      <section id="weight" class="page">
        <h1>Weight Tracking</h1>
        <button id="resetWeightButton" class="reset-btn">Reset Weight Data</button>    
        
        
        <!-- Responsive Chart Container -->
        <div class="chart-container">
          <canvas id="weightChart"></canvas>
        </div>

        <!-- Additional line breaks before the form -->
        <br><br>

        <form id="weightForm">
          <label for="weightInput">Enter Weight (kg):</label><br>
          <input type="number" id="weightInput" step="0.1" required /><br><br>
          
          <label for="notes">Notes:</label><br>
          <input type="text" id="notes" placeholder="E.g., morning post-poo" /><br><br>
          
          <button type="submit">Add Weight</button>
        </form>

        <h2>Weight Records</h2>
        <table id="weightTable">
          <thead>
            <tr>
              <th>Date</th>
              <th>Weight (kg)</th>
              <th>Weekly Avg</th>
              <th>Notes</th>
            </tr>
          </thead>
          <tbody>
          </tbody>
        </table>
      </section>
    </main>

    <footer>
      <p>Êú¨Êù•„ÅÆÈù¢ÁõÆ, Honrai No Menmoku &copy; 2025</p>
    </footer>

    <script>
  document.getElementById("weightForm").addEventListener("submit", function (event) {
    event.preventDefault();
    
    const weight = parseFloat(document.getElementById("weightInput").value);
    const notes = document.getElementById("notes").value;
    const date = new Date().toISOString().split("T")[0];

    let weightData = JSON.parse(localStorage.getItem("weightData")) || [];

    // Append new weight entry
    weightData.push({ date, weight, notes });

    localStorage.setItem("weightData", JSON.stringify(weightData));

    updateWeightTable();
    updateChart();
  });

  function updateWeightTable() {
    const tbody = document.querySelector("#weightTable tbody");
    tbody.innerHTML = "";

    let weightData = JSON.parse(localStorage.getItem("weightData")) || [];

    // Group entries by date and calculate daily averages
    let dailyWeights = {};
    weightData.forEach(entry => {
        if (!dailyWeights[entry.date]) {
            dailyWeights[entry.date] = { total: 0, count: 0, notes: [] };
        }
        dailyWeights[entry.date].total += entry.weight;
        dailyWeights[entry.date].count++;
        if (entry.notes) dailyWeights[entry.date].notes.push(entry.notes);
    });

    // Compute weekly rolling average
    let datesSorted = Object.keys(dailyWeights).sort();
    let rollingWeights = [];

    datesSorted.forEach((date, index) => {
        let avgWeight = (dailyWeights[date].total / dailyWeights[date].count).toFixed(1);
        rollingWeights.push(parseFloat(avgWeight));

        let weeklyAvg = "-";
        if (index >= 6) {
            let weekSlice = rollingWeights.slice(index - 6, index + 1);
            weeklyAvg = (weekSlice.reduce((a, b) => a + b, 0) / 7).toFixed(1);
        }

        // Convert date to DD-MM-YYYY format
        let formattedDate = date.split("-").reverse().join("-");

        tbody.innerHTML += `
            <tr>
                <td>${formattedDate}</td>
                <td>${avgWeight}</td>
                <td>${weeklyAvg}</td>
                <td>${dailyWeights[date].notes.join(", ")}</td>
            </tr>
        `;
    });
}

function updateChart() {
    let weightData = JSON.parse(localStorage.getItem("weightData")) || [];
    if (weightData.length === 0) return;

    let dailyWeights = {};
    weightData.forEach(entry => {
        if (!dailyWeights[entry.date]) {
            dailyWeights[entry.date] = { total: 0, count: 0 };
        }
        dailyWeights[entry.date].total += entry.weight;
        dailyWeights[entry.date].count++;
    });

    // Find the earliest and latest date in the dataset
    let allDates = Object.keys(dailyWeights).sort();
    let startDate = new Date(allDates[0]); // First date in the dataset
    let endDate = new Date(allDates[allDates.length - 1]); // Last date

    // Fill in all missing dates to ensure a linear timeline
    let filledDates = [];
    let tempDate = new Date(startDate);

    while (tempDate <= endDate) {
        let dateStr = tempDate.toISOString().split("T")[0];
        filledDates.push(dateStr);
        tempDate.setDate(tempDate.getDate() + 1); // Move to next day
    }

    // Build corresponding weight values (empty for missing days)
    let avgWeights = filledDates.map(date => {
        if (dailyWeights[date]) {
            return (dailyWeights[date].total / dailyWeights[date].count).toFixed(1);
        } else {
            return null; // Keep missing days empty
        }
    });

    // Convert dates to DD-MM format for X-axis labels
    let formattedDates = filledDates.map(date => {
        let parts = date.split("-");
        return `${parts[2]}-${parts[1]}`; // Convert YYYY-MM-DD to DD-MM
    });

    // Generate trendline
    function linearRegression(x, y) {
    let validX = [];
    let validY = [];

    // Filter out null values so only actual weight entries are used
    y.forEach((val, index) => {
        if (val !== null) {
            validX.push(x[index]);
            validY.push(parseFloat(val));
        }
    });

    if (validX.length < 2) return y; // Not enough data for a trendline

    const n = validX.length;
    const sumX = validX.reduce((a, b) => a + b, 0);
    const sumY = validY.reduce((a, b) => a + b, 0);
    const sumXY = validX.map((xi, i) => xi * validY[i]).reduce((a, b) => a + b, 0);
    const sumX2 = validX.map(xi => xi * xi).reduce((a, b) => a + b, 0);

    const slope = (n * sumXY - sumX * sumY) / (n * sumX2 - sumX * sumX);
    const intercept = (sumY - slope * sumX) / n;

    return x.map(xi => validX.includes(xi) ? slope * xi + intercept : null);
}

    let xVals = filledDates.map((_, i) => i);
    let trendline = linearRegression(xVals, avgWeights);

    // Destroy previous chart instance before creating a new one
    const ctx = document.getElementById("weightChart").getContext("2d");
    if (window.myChart) {
        window.myChart.destroy();
    }

    window.myChart = new Chart(ctx, {
        type: "line",
        data: {
            labels: formattedDates, // Linearized daily labels
            datasets: [
                {
                    label: "Daily Avg Weight",
                    data: avgWeights,
                    borderColor: "blue",
                    fill: false,
                    pointStyle: "circle",
                    pointRadius: 3, // Adjust marker size
                    borderWidth: 2, // Make the line more visible
                    spanGaps: false, // Keep gaps for missing data
                },
                {
                    label: "Trendline",
                    data: trendline,
                    borderColor: "red",
                    borderDash: [5, 5],
                    fill: false,
                    borderWidth: 2,
                    spanGaps: true, // Allow trendline to connect valid data
                },
            ],
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                x: {
                    ticks: {
                        autoSkip: false, // Ensure all days are represented
                        maxRotation: 30, // Slightly rotate for better visibility
                        minRotation: 30,
                        font: { size: 14 },
                        callback: function (value, index, values) {
                            return index % 3 === 0 ? this.getLabelForValue(value) : "";
                        },
                    },
                    grid: {
                        display: true,
                        color: "rgba(200, 200, 200, 0.5)", // Light grey vertical gridlines
                    },
                },
                y: {
                    beginAtZero: false,
                    ticks: {
                        stepSize: 1,
                        font: { size: 14 },
                    },
                    grid: {
                        display: true,
                        color: "rgba(180, 180, 180, 0.7)", // Slightly darker grey
                    },
                },
            },
        },
    });
}

window.onload = function () {
    updateWeightTable();
    updateChart();
};

document.getElementById("resetWeightButton").addEventListener("click", function() {
  if (confirm("Are you sure you want to delete all weight data? This cannot be undone.")) {
    // Remove weight data from localStorage
    localStorage.removeItem("weightData");
    
    // Clear the table and chart
    document.querySelector("#weightTable tbody").innerHTML = "";
    
    // Reset the chart
    if (window.myChart) {
      window.myChart.data.labels = [];
      window.myChart.data.datasets[0].data = [];
      window.myChart.data.datasets[1].data = [];
      window.myChart.update();
    }
    
    alert("Weight data has been cleared.");
  }
  //CREATE FAKE DATA
  window.onload = function () {
    if (!localStorage.getItem("weightData")) {
        let weightData = [];
        let startWeight = 80; // Starting weight
        let startDate = new Date();
        startDate.setDate(startDate.getDate() - 10); // Go back 10 days

        for (let i = 0; i < 10; i++) {
            let date = new Date(startDate);
            date.setDate(startDate.getDate() + i);
            let formattedDate = date.toISOString().split("T")[0];

            let weight = (startWeight - (i * 0.2)).toFixed(1); // Simulate weight loss

            weightData.push({
                date: formattedDate,
                weight: parseFloat(weight),
                notes: "Auto-generated test data"
            });
        }

        // Save to localStorage
        localStorage.setItem("weightData", JSON.stringify(weightData));
        console.log("‚úÖ Auto-loaded 10 days of weight data.");
    }

    // Ensure UI updates
    if (typeof updateWeightTable === "function") updateWeightTable();
    if (typeof updateChart === "function") updateChart();
};
  //END CREATE FAKE DATA
});      
    
</script>

  </body>
</html>
