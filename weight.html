<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>本来の面目, Honrai No Menmoku - Weight Tracking</title>
    <link rel="stylesheet" href="styles.css" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
      /* Make sure the chart container scales nicely */
      #weightChart {
        width: 100%;
        /* You can set a max-height if you like, e.g. 600px */
        max-height: 600px;
      }
      
      /* Simple responsive helper for the canvas container */
      .chart-container {
        position: relative;
        width: 100%;
        max-width: 800px; /* Adjust as desired */
        margin: 0 auto;   /* Center it */
      }
    </style>
  </head>

  <body>
    <nav>
      <ul>
        <li><a href="index.html">🏠 Home</a></li>
        <li><a href="bmr.html">🏋️ BMR</a></li>
        <li><a href="weight.html">📉 Weight</a></li>
        <li><a href="meals.html">🍽️ Meals</a></li>
        <li><a href="chat.html">💬 AI Chat</a></li>
      </ul>
    </nav>

    <main>
      <section id="weight" class="page">
        <h1>Weight Tracking</h1>
        
        <!-- Responsive Chart Container -->
        <div class="chart-container">
          <canvas id="weightChart"></canvas>
        </div>

        <!-- Additional line breaks before the form -->
        <br><br>

        <form id="weightForm">
          <label for="weightInput">Enter Weight (kg):</label><br>
          <input type="number" id="weightInput" step="0.1" required /><br><br>
          
          <label for="notes">Notes:</label><br>
          <input type="text" id="notes" placeholder="E.g., morning post-poo" /><br><br>
          
          <button type="submit">Add Weight</button>
        </form>

        <h2>Weight Records</h2>
        <table id="weightTable">
          <thead>
            <tr>
              <th>Date</th>
              <th>Weight (kg)</th>
              <th>Weekly Avg</th>
              <th>Notes</th>
            </tr>
          </thead>
          <tbody>
          </tbody>
        </table>
      </section>
    </main>

    <footer>
      <p>本来の面目, Honrai No Menmoku &copy; 2025</p>
    </footer>

    <script>
  document.getElementById("weightForm").addEventListener("submit", function (event) {
    event.preventDefault();
    
    const weight = parseFloat(document.getElementById("weightInput").value);
    const notes = document.getElementById("notes").value;
    const date = new Date().toISOString().split("T")[0];

    let weightData = JSON.parse(localStorage.getItem("weightData")) || [];

    // Append new weight entry
    weightData.push({ date, weight, notes });

    localStorage.setItem("weightData", JSON.stringify(weightData));

    updateWeightTable();
    updateChart();
  });

  function updateWeightTable() {
    const tbody = document.querySelector("#weightTable tbody");
    tbody.innerHTML = "";

    let weightData = JSON.parse(localStorage.getItem("weightData")) || [];

    // Group entries by date and calculate daily averages
    let dailyWeights = {};
    weightData.forEach(entry => {
      if (!dailyWeights[entry.date]) {
        dailyWeights[entry.date] = { total: 0, count: 0, notes: [] };
      }
      dailyWeights[entry.date].total += entry.weight;
      dailyWeights[entry.date].count++;
      if (entry.notes) dailyWeights[entry.date].notes.push(entry.notes);
    });

    // Compute weekly rolling average
    let datesSorted = Object.keys(dailyWeights).sort();
    let rollingWeights = [];

    datesSorted.forEach((date, index) => {
      let avgWeight = (dailyWeights[date].total / dailyWeights[date].count).toFixed(1);
      rollingWeights.push(parseFloat(avgWeight));

      let weeklyAvg = "-";
      if (index >= 6) {
        let weekSlice = rollingWeights.slice(index - 6, index + 1);
        weeklyAvg = (weekSlice.reduce((a, b) => a + b, 0) / 7).toFixed(1);
      }

      tbody.innerHTML += `
        <tr>
          <td>${date}</td>
          <td>${avgWeight}</td>
          <td>${weeklyAvg}</td>
          <td>${dailyWeights[date].notes.join(", ")}</td>
        </tr>
      `;
    });
  }

  function updateChart() {
    let weightData = JSON.parse(localStorage.getItem("weightData")) || [];
    if (weightData.length === 0) return;

    let dailyWeights = {};
    weightData.forEach(entry => {
      if (!dailyWeights[entry.date]) {
        dailyWeights[entry.date] = { total: 0, count: 0 };
      }
      dailyWeights[entry.date].total += entry.weight;
      dailyWeights[entry.date].count++;
    });

    let dates = Object.keys(dailyWeights).sort();
    let avgWeights = dates.map(date => (dailyWeights[date].total / dailyWeights[date].count).toFixed(1));

    // Generate trendline
    function linearRegression(x, y) {
      const n = x.length;
      const sumX = x.reduce((a, b) => a + b, 0);
      const sumY = y.reduce((a, b) => a + b, 0);
      const sumXY = x.map((xi, i) => xi * y[i]).reduce((a, b) => a + b, 0);
      const sumX2 = x.map(xi => xi * xi).reduce((a, b) => a + b, 0);

      const slope = (n * sumXY - sumX * sumY) / (n * sumX2 - sumX * sumX);
      const intercept = (sumY - slope * sumX) / n;

      return x.map(xi => slope * xi + intercept);
    }

    let xVals = dates.map((_, i) => i);
    let trendline = linearRegression(xVals, avgWeights.map(Number));

    // Destroy previous chart instance before creating a new one
    const ctx = document.getElementById("weightChart").getContext("2d");
    if (window.myChart) {
      window.myChart.destroy();
    }

    window.myChart = new Chart(ctx, {
      type: "line",
      data: {
        labels: dates,
        datasets: [
          {
            label: "Daily Avg Weight",
            data: avgWeights,
            borderColor: "blue",
            fill: false,
          },
          {
            label: "Trendline",
            data: trendline,
            borderColor: "red",
            borderDash: [5, 5],
            fill: false,
          },
        ],
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          x: { ticks: { autoSkip: true, maxRotation: 0, minRotation: 0 } },
          y: { beginAtZero: false },
        },
      },
    });
  }

  window.onload = function () {
    updateWeightTable();
    updateChart();
  };
</script>

  </body>
</html>
