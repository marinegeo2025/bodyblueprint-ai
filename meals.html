<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Êú¨Êù•„ÅÆÈù¢ÁõÆ, Honrai No Menmoku</title>
    <link rel="stylesheet" href="styles.css" />
    <style>
      #mealList {
        list-style-type: none;
        padding: 0;
      }
      #mealList li {
        margin-bottom: 5px;
      }
    </style>
  </head>
  <body>
    <nav>
      <ul>
        <li><a href="index.html">üè† Home</a></li>
        <li><a href="bmr.html">üèãÔ∏è BMR</a></li>
        <li><a href="weight.html">üìâ Weight</a></li>
        <li><a href="meals.html">üçΩÔ∏è Meals</a></li>
        <li><a href="chat.html">üí¨ AI Chat</a></li>
      </ul>
    </nav>
    <main>
      <section id="meals" class="page">
        <h1>Meal Tracker</h1>
        <button id="resetDataButton" class="reset-btn">Reset Day</button>

        <p>Enter your meal below and get calorie and protein estimates.</p>

        <form id="mealForm">
          <label for="mealInput">Describe your meal:</label><br />
          <input type="text" id="mealInput" placeholder="E.g., 2 eggs, toast, butter" required />
          <button type="submit" id="addMealButton">Add Meal</button>
        </form>

        <h2>Today's Nutrition</h2>
        <p><strong>Goal:</strong> <span id="goalDisplay">None</span></p>
        <p><strong>Calories:</strong> <span id="totalCalories">0</span> / <span id="targetCalories">0</span> kcal</p>
        <div class="progress-bar-container">
          <div id="calorieProgress" class="progress-bar green"></div>
        </div>
        <p><strong>Protein:</strong> <span id="totalProtein">0</span>g / <span id="targetProtein">0</span>g</p>
        <div class="progress-bar-container">
          <div id="proteinProgress" class="progress-bar yellow"></div>
        </div>

        <h2>Meal Records</h2>
        <ul id="mealList"></ul>

        <h2>Daily Summary</h2>
        <p id="dailySummary">Awaiting meal entries...</p>
      </section>
    </main>

    <footer>
      <p>Êú¨Êù•„ÅÆÈù¢ÁõÆ, Honrai No Menmoku &copy; 2025</p>
    </footer>

    <script>

document.addEventListener("DOMContentLoaded", function () {
  // 1Ô∏è‚É£ Load Goal, TDEE, etc. from localStorage
  const storedGoal = localStorage.getItem("goal") || "None";
  const storedTargetCalories = parseInt(localStorage.getItem("targetCalories")) || 2000;
  const storedWeight = parseFloat(localStorage.getItem("weight")) || 70;
  const storedActivityLevel = localStorage.getItem("activity") || "moderate";

  // Calculate protein target from user‚Äôs stored data
  document.getElementById("goalDisplay").innerText = storedGoal;
  document.getElementById("targetCalories").innerText = storedTargetCalories;

  let proteinMultiplier = 1.2;
  if (storedGoal.includes("Cut") || storedGoal.includes("Bulk")) proteinMultiplier = 1.6;
  if (storedActivityLevel === "high") proteinMultiplier = 1.7;

  const targetProtein = Math.round(storedWeight * proteinMultiplier);
  document.getElementById("targetProtein").innerText = targetProtein;

  // 2Ô∏è‚É£ Function to restore previously stored progress bar colors
  function restoreProgressBarColor(barId, defaultColor) {
    const color = localStorage.getItem(`${barId}-color`) || defaultColor;
    document.getElementById(barId).classList.add(color);
  }

  // 3Ô∏è‚É£ Function to set + store progress bar colors
  function setProgressBarColor(barId, color) {
    const progressBar = document.getElementById(barId);
    if (progressBar) {
      progressBar.classList.add(color);
      localStorage.setItem(`${barId}-color`, color);
    } else {
      console.error(`‚ùå Progress bar with ID ${barId} not found.`);
    }
  }

  // 4Ô∏è‚É£ Reset Button: clears only meal-related data from localStorage
  document.getElementById("resetDataButton").addEventListener("click", function () {
    console.log("üîÑ Resetting daily meal data...");
    localStorage.removeItem("mealHistory");
    localStorage.removeItem("totalCalories");
    localStorage.removeItem("totalProtein");
    localStorage.removeItem("dailySummary");

    document.getElementById("mealList").innerHTML = "";
    document.getElementById("totalCalories").innerText = "0";
    document.getElementById("totalProtein").innerText = "0";
    document.getElementById("calorieProgress").style.width = "0%";
    document.getElementById("proteinProgress").style.width = "0%";
    document.getElementById("dailySummary").innerText = "Awaiting meal entries...";

    console.log("‚úÖ Daily meal data has been reset!");
  });

  // 5Ô∏è‚É£ ‚ÄúAdd Meal‚Äù 2-step approach: first parse the new meal alone, then fetch full summary
  async function addMealFlow(userMealInput) {
    const oldMeals = JSON.parse(localStorage.getItem("mealHistory")) || [];

    // --- STEP A: Parse macros for JUST this new meal ---
    const parseBody = {
      meal: userMealInput,
      previousMeals: [], // No previous meals (we want macros for only this meal)
      goal: localStorage.getItem("goal") || "None",
      targetCalories: parseInt(localStorage.getItem("targetCalories")) || 2000,
      activityLevel: localStorage.getItem("activity") || "moderate",
      BMR: parseInt(localStorage.getItem("bmr")) || 1800,
      totalProtein: parseInt(localStorage.getItem("totalProtein")) || 0,
      weightData: JSON.parse(localStorage.getItem("weightData")) || []
    };

    let parseJson;
    try {
      const parseResponse = await fetch("/api/analyze-meal", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(parseBody),
      });
      parseJson = await parseResponse.json();
      console.log("üîé Step A parseJson:", parseJson);
      if (parseJson.error) {
        throw new Error("Meal parsing failed: " + parseJson.error);
      }
    } catch (err) {
      console.error("‚ùå Step A parse request error:", err);
      alert("Error parsing this meal. Please try again.");
      return;
    }

    // Macros for the brand-new meal
    const newMealMacros = {
      name: userMealInput,
      calories: parseJson.calories || 0,
      protein: parseJson.protein || 0,
    };
    console.log("Step A newMealMacros:", newMealMacros);

    // Save the new meal to mealHistory in localStorage
    oldMeals.push(newMealMacros);
    localStorage.setItem("mealHistory", JSON.stringify(oldMeals));

    // Update local totals + progress bars from just the new meal
    updateMealList(newMealMacros.name, newMealMacros.calories, newMealMacros.protein);
    updateProgress(newMealMacros.calories, newMealMacros.protein,
      parseInt(localStorage.getItem("targetCalories")) || 2000,
      parseInt(localStorage.getItem("targetProtein")) || 0
    );

    // --- STEP B: Now get an updated daily summary (with all meals so far) ---
    const summaryBody = {
      meal: "", // No new meal to parse
      previousMeals: oldMeals, // includes the newly added meal
      goal: localStorage.getItem("goal") || "None",
      targetCalories: parseInt(localStorage.getItem("targetCalories")) || 2000,
      activityLevel: localStorage.getItem("activity") || "moderate",
      BMR: parseInt(localStorage.getItem("bmr")) || 1800,
      totalProtein: parseInt(localStorage.getItem("totalProtein")) || 0,
      weightData: JSON.parse(localStorage.getItem("weightData")) || []
    };

    let summaryJson;
    try {
      const summaryResponse = await fetch("/api/analyze-meal", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(summaryBody),
      });
      summaryJson = await summaryResponse.json();
      console.log("üîé Step B summaryJson:", summaryJson);
      if (summaryJson.error) {
        throw new Error("Daily summary failed: " + summaryJson.error);
      }
    } catch (err) {
      console.error("‚ùå Step B summary request error:", err);
      alert("Error retrieving daily summary. Please try again.");
      return;
    }

    // Display daily summary
    if (summaryJson.daily_summary && summaryJson.daily_summary.trim() !== "") {
      console.log("üìå Storing daily summary:", summaryJson.daily_summary);
      document.getElementById("dailySummary").innerText = summaryJson.daily_summary;
      localStorage.setItem("dailySummary", summaryJson.daily_summary);
    } else {
      console.warn("‚ö†Ô∏è No daily summary in Step B response.");
      document.getElementById("dailySummary").innerText = "Awaiting meal entries...";
    }

    // Re-render the UI from localStorage (Meal list, etc.)
    updateUIFromStorage();
  }

  // 6Ô∏è‚É£ Hook the form‚Äôs ‚Äúsubmit‚Äù to use addMealFlow
  document.getElementById("mealForm").addEventListener("submit", async function (event) {
    event.preventDefault();
    const mealInput = document.getElementById("mealInput").value.trim();
    const addMealButton = document.getElementById("addMealButton");

    if (!mealInput) return;

    addMealButton.textContent = "Processing...";
    addMealButton.disabled = true;

    await addMealFlow(mealInput);

    addMealButton.textContent = "Add Meal";
    addMealButton.disabled = false;
    document.getElementById("mealInput").value = "";
  });

  // 7Ô∏è‚É£ Helper: Display newly added meal in the ‚ÄúMeal Records‚Äù list
  function updateMealList(meal, calories, protein) {
    const mealList = document.getElementById("mealList");
    const listItem = document.createElement("li");
    listItem.innerHTML = `<strong>${meal}</strong>: ${calories} kcal, ${protein}g protein`;
    mealList.appendChild(listItem);
  }

  // 8Ô∏è‚É£ Helper: Update progress bar and store totals
  function updateProgress(calories, protein, targetCalories, targetProtein) {
    console.log("üîÑ Updating progress bars...");
    const oldCals = parseInt(localStorage.getItem("totalCalories")) || 0;
    const oldProtein = parseInt(localStorage.getItem("totalProtein")) || 0;

    const totalCalories = oldCals + calories;
    const totalProtein = oldProtein + protein;

    document.getElementById("totalCalories").innerText = totalCalories;
    document.getElementById("totalProtein").innerText = totalProtein;

    const caloriePercent = Math.min((totalCalories / targetCalories) * 100, 100);
    const proteinPercent = Math.min((totalProtein / targetProtein) * 100, 100);

    document.getElementById("calorieProgress").style.width = `${caloriePercent}%`;
    document.getElementById("proteinProgress").style.width = `${proteinPercent}%`;

    setProgressBarColor("calorieProgress", "green");
    setProgressBarColor("proteinProgress", "yellow");

    localStorage.setItem("totalCalories", totalCalories);
    localStorage.setItem("totalProtein", totalProtein);
  }

  // 9Ô∏è‚É£ On Page Load, restore any existing data from localStorage
  function updateUIFromStorage() {
    console.log("üîÑ Restoring UI from localStorage...");

    document.getElementById("mealList").innerHTML = "";

    const meals = JSON.parse(localStorage.getItem("mealHistory")) || [];
    meals.forEach(meal => updateMealList(meal.name, meal.calories, meal.protein));

    const totalCalories = parseInt(localStorage.getItem("totalCalories")) || 0;
    const totalProtein = parseInt(localStorage.getItem("totalProtein")) || 0;
    const targetCalories = parseInt(localStorage.getItem("targetCalories")) || 2000;
    const targetProtein = parseInt(localStorage.getItem("targetProtein")) || 100;

    document.getElementById("totalCalories").innerText = totalCalories;
    document.getElementById("totalProtein").innerText = totalProtein;

    document.getElementById("calorieProgress").style.width = `${Math.min((totalCalories / targetCalories) * 100, 100)}%`;
    document.getElementById("proteinProgress").style.width = `${Math.min((totalProtein / targetProtein) * 100, 100)}%`;

    restoreProgressBarColor("calorieProgress", "green");
    restoreProgressBarColor("proteinProgress", "yellow");

    const dailySummary = localStorage.getItem("dailySummary") || "Awaiting meal entries...";
    document.getElementById("dailySummary").innerText = dailySummary;

    console.log("‚úÖ UI restored from localStorage!");
  }

  // Finally, call updateUIFromStorage() right away so the page loads existing data
  updateUIFromStorage();
});

    </script>
  </body>
</html>
