<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Êú¨Êù•„ÅÆÈù¢ÁõÆ, Honrai No Menmoku</title>
    <link rel="stylesheet" href="styles.css" />
    <style>
      #mealList {
        list-style-type: none;
        padding: 0;
      }
      #mealList li {
        margin-bottom: 5px;
      }
    </style>
  </head>
  <body>
    <nav>
      <ul>
        <li><a href="index.html">üè† Home</a></li>
        <li><a href="bmr.html">üèãÔ∏è BMR</a></li>
        <li><a href="weight.html">üìâ Weight</a></li>
        <li><a href="meals.html">üçΩÔ∏è Meals</a></li>
        <li><a href="chat.html">üí¨ AI Chat</a></li>
      </ul>
    </nav>
    <main>
      <section id="meals" class="page">
        <h1>Meal Tracker</h1>
        <button id="resetDataButton" class="reset-btn">Reset Day</button>

        <p>Enter your meal below and get calorie and protein estimates.</p>

        <form id="mealForm">
          <label for="mealInput">Describe your meal:</label><br />
          <input type="text" id="mealInput" placeholder="E.g., 2 eggs, toast, butter" required />
          <button type="submit" id="addMealButton">Add Meal</button>
        </form>

        <h2>Today's Nutrition</h2>
        <p><strong>Goal:</strong> <span id="goalDisplay">None</span></p>
        <p><strong>Calories:</strong> <span id="totalCalories">0</span> / <span id="targetCalories">0</span> kcal</p>
        <div class="progress-bar-container">
          <div id="calorieProgress" class="progress-bar green"></div>
        </div>
        <p><strong>Protein:</strong> <span id="totalProtein">0</span>g / <span id="targetProtein">0</span>g</p>
        <div class="progress-bar-container">
          <div id="proteinProgress" class="progress-bar yellow"></div>
        </div>

        <h2>Meal Records</h2>
        <ul id="mealList"></ul>

        <h2>Daily Summary</h2>
        <p id="dailySummary">Awaiting meal entries...</p>
      </section>
    </main>

    <footer>
      <p>Êú¨Êù•„ÅÆÈù¢ÁõÆ, Honrai No Menmoku &copy; 2025</p>
    </footer>

    <script>
      function calculateProteinTarget() {
          let weight = parseFloat(localStorage.getItem("weight")) || 70; // Default 70kg
          let goal = localStorage.getItem("goal") || "Maintain";
          let activityLevel = localStorage.getItem("activity") || "moderate";

          let proteinMultiplier = goal.includes("Cut") || goal.includes("Bulk") ? 1.6 : 1.2;
          if (activityLevel === "high") proteinMultiplier = 1.7;

          return Math.round(weight * proteinMultiplier);
      }

      function updateDailySummary(summary) {
    console.log("üì¢ Updating daily summary:", summary);
    
    if (!summary || summary.trim() === "") {
        summary = "No summary available.";
    }

    document.getElementById("dailySummary").innerText = summary;
    localStorage.setItem("dailySummary", summary);
}

      document.addEventListener("DOMContentLoaded", function () {
    document.getElementById("goalDisplay").innerText = localStorage.getItem("goal") || "None";

    let savedMeals = JSON.parse(localStorage.getItem("mealHistory")) || [];
    savedMeals.forEach(meal => updateMealList(meal.name, meal.calories, meal.protein));

    let totalCalories = parseInt(localStorage.getItem("totalCalories")) || 0;
    let totalProtein = parseInt(localStorage.getItem("totalProtein")) || 0;
    let targetCalories = parseInt(localStorage.getItem("targetCalories")) || 2000;
    let targetProtein = calculateProteinTarget();

    document.getElementById("totalCalories").innerText = totalCalories;
    document.getElementById("targetCalories").innerText = targetCalories;
    document.getElementById("totalProtein").innerText = totalProtein;
    document.getElementById("targetProtein").innerText = targetProtein;

    document.getElementById("dailySummary").innerText = localStorage.getItem("dailySummary") || "Awaiting meal entries...";

    // ‚úÖ Ensure progress bars are updated when the page loads
    updateProgressBars();
});

      document.getElementById("mealForm").addEventListener("submit", async function (event) {
    event.preventDefault();
    const mealInput = document.getElementById("mealInput").value;
    const addMealButton = document.getElementById("addMealButton");
    if (!mealInput) return;

    addMealButton.textContent = "Processing...";
    addMealButton.disabled = true;

    let savedMeals = JSON.parse(localStorage.getItem("mealHistory")) || [];
    try {
        console.log("‚úÖ Sending meal request:", mealInput);

        const response = await fetch("/api/analyze-meal", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                meal: mealInput,
                previousMeals: savedMeals,
                goal: localStorage.getItem("goal") || "None",
                targetCalories: parseInt(localStorage.getItem("targetCalories")) || 2000,
                activityLevel: localStorage.getItem("activity") || "moderate"
            }),
        });

        const result = await response.json();
        console.log("ü§ñ AI Response:", result);

        if (result && typeof result.calories === "number" && typeof result.protein === "number") {
            console.log("üìä Updating UI with new meal data...");
            updateMealList(mealInput, result.calories, result.protein);
            updateProgress(result.calories, result.protein);
            updateDailySummary(result.daily_summary || "No summary available.");

            savedMeals.push({ name: mealInput, calories: result.calories, protein: result.protein });
            localStorage.setItem("mealHistory", JSON.stringify(savedMeals));
        } else {
            console.error("‚ö†Ô∏è API returned invalid data format:", result);
        }
    } catch (error) {
        console.error("‚ùå Error processing meal:", error);
    } finally {
        addMealButton.textContent = "Add Meal";
        addMealButton.disabled = false;
    }
});

      function updateMealList(meal, calories, protein) {
          const mealList = document.getElementById("mealList");
          const listItem = document.createElement("li");
          listItem.innerHTML = `<strong>${meal}</strong>: ${calories} kcal, ${protein}g protein`;
          mealList.appendChild(listItem);
      }

      function updateTotals(calories, protein) {
          let totalCalories = parseInt(localStorage.getItem("totalCalories")) || 0;
          let totalProtein = parseInt(localStorage.getItem("totalProtein")) || 0;

          totalCalories += calories;
          totalProtein += protein;

          localStorage.setItem("totalCalories", totalCalories);
          localStorage.setItem("totalProtein", totalProtein);

          document.getElementById("totalCalories").innerText = totalCalories;
          document.getElementById("totalProtein").innerText = totalProtein;

          updateProgressBars();
      }

      function updateProgress(calories, protein) {
    console.log("üìä Updating progress bars...");
    
    let totalCalories = parseInt(localStorage.getItem("totalCalories")) || 0;
    let totalProtein = parseInt(localStorage.getItem("totalProtein")) || 0;
    let targetCalories = parseInt(localStorage.getItem("targetCalories")) || 2000;
    let targetProtein = calculateProteinTarget();

    totalCalories += calories;
    totalProtein += protein;

    localStorage.setItem("totalCalories", totalCalories);
    localStorage.setItem("totalProtein", totalProtein);

    document.getElementById("totalCalories").innerText = totalCalories;
    document.getElementById("targetCalories").innerText = targetCalories;
    document.getElementById("totalProtein").innerText = totalProtein;
    document.getElementById("targetProtein").innerText = targetProtein;

    document.getElementById("calorieProgress").style.width = `${Math.min((totalCalories / targetCalories) * 100, 100)}%`;
    document.getElementById("proteinProgress").style.width = `${Math.min((totalProtein / targetProtein) * 100, 100)}%`;

    console.log(`‚úÖ Calories Updated: ${totalCalories}/${targetCalories}`);
    console.log(`‚úÖ Protein Updated: ${totalProtein}/${targetProtein}`);
}

    </script>
  </body>
</html>
