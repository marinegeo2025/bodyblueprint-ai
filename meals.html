<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Êú¨Êù•„ÅÆÈù¢ÁõÆ, Honrai No Menmoku</title>
    <link rel="stylesheet" href="styles.css" />
  </head>
  <body>
    <nav>
      <ul>
        <li><a href="index.html">üè† Home</a></li>
        <li><a href="bmr.html">üèãÔ∏è BMR</a></li>
        <li><a href="weight.html">üìâ Weight</a></li>
        <li><a href="meals.html">üçΩÔ∏è Meals</a></li>
        <li><a href="chat.html">üí¨ AI Chat</a></li>
      </ul>
    </nav>
    <main>
      <section id="meals" class="page">
        <h1>Meal Tracker</h1>
        <p>Enter your meal below and get calorie & protein estimates.</p>

        <form id="mealForm">
          <label for="mealInput">Describe your meal:</label><br />
          <input type="text" id="mealInput" placeholder="E.g., 2 eggs, toast, butter" required />
          <button type="submit">Add Meal</button>
        </form>

        <h2>Today's Nutrition</h2>
        <p><strong>Goal:</strong> <span id="goalDisplay">None</span></p>
        <p><strong>Calories:</strong> <span id="totalCalories">0</span> kcal</p>
        <div class="progress-bar-container">
          <div id="calorieProgress" class="progress-bar green"></div>
        </div>
        <p><strong>Protein:</strong> <span id="totalProtein">0</span> g</p>
        <div class="progress-bar-container">
          <div id="proteinProgress" class="progress-bar yellow"></div>
        </div>

        <h2>Meal Records</h2>
        <ul id="mealList"></ul>
        <h2>Daily Summary</h2>
        <p id="dailySummary">Awaiting meal entries...</p>
      </section>
    </main>

    <footer>
      <p>Êú¨Êù•„ÅÆÈù¢ÁõÆ, Honrai No Menmoku &copy; 2025</p>
    </footer>

    <script>
      document.getElementById("mealForm").addEventListener("submit", async function (event) {
        event.preventDefault();
        const mealInput = document.getElementById("mealInput").value;
        if (!mealInput) return;

        const storedGoal = localStorage.getItem("goal") || "None";
        const storedTargetCalories = parseInt(localStorage.getItem("targetCalories")) || 0;

        try {
          const response = await fetch("/api/analyze-meal", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ meal: mealInput, goal: storedGoal, targetCalories: storedTargetCalories })
          });

          const result = await response.json();
          if (result && typeof result.calories === "number" && typeof result.protein === "number") {
            updateMealList(mealInput, result.calories, result.protein);
            updateProgress(result.calories, result.protein);
            document.getElementById("dailySummary").innerText = result.recommendation;
          }
        } catch (error) {
          console.error("Error processing meal:", error);
        }
      });

      function updateMealList(meal, calories, protein) {
        const mealList = document.getElementById("mealList");
        const listItem = document.createElement("li");
        listItem.innerHTML = `<strong>${meal}</strong> - ${calories} kcal, ${protein}g protein`;
        mealList.appendChild(listItem);
      }

      function updateProgress(calories, protein) {
        const targetCalories = parseInt(localStorage.getItem("targetCalories")) || 0;
        const totalCalories = parseInt(document.getElementById("totalCalories").innerText) + calories;
        const totalProtein = parseInt(document.getElementById("totalProtein").innerText) + protein;
        
        document.getElementById("totalCalories").innerText = totalCalories;
        document.getElementById("totalProtein").innerText = totalProtein;
        
        const caloriePercent = targetCalories ? (totalCalories / targetCalories) * 100 : 0;
        document.getElementById("calorieProgress").style.width = `${Math.min(caloriePercent, 100)}%`;
        
        const proteinPercent = (totalProtein / 100) * 100;
        document.getElementById("proteinProgress").style.width = `${Math.min(proteinPercent, 100)}%`;
      }
    </script>
  </body>
</html>
