<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Êú¨Êù•„ÅÆÈù¢ÁõÆ, Honrai No Menmoku</title>
    <link rel="stylesheet" href="styles.css" />
    <style>
      #mealList {
        list-style-type: none;
        padding: 0;
      }
      #mealList li {
        margin-bottom: 5px;
      }
    </style>
  </head>
  <body>
    <nav>
      <ul>
        <li><a href="index.html">üè† Home</a></li>
        <li><a href="bmr.html">üèãÔ∏è BMR</a></li>
        <li><a href="weight.html">üìâ Weight</a></li>
        <li><a href="meals.html">üçΩÔ∏è Meals</a></li>
        <li><a href="chat.html">üí¨ AI Chat</a></li>
      </ul>
    </nav>
    <main>
      <section id="meals" class="page">
        <h1>Meal Tracker</h1>
        <button id="resetDataButton" class="reset-btn">Reset Day</button>

        <p>Enter your meal below and get calorie and protein estimates.</p>

        <form id="mealForm">
          <label for="mealInput">Describe your meal:</label><br />
          <input type="text" id="mealInput" placeholder="E.g., 2 eggs, toast, butter" required />
          <button type="submit" id="addMealButton">Add Meal</button>
        </form>

        <h2>Today's Nutrition</h2>
        <p><strong>Goal:</strong> <span id="goalDisplay">None</span></p>
        <p><strong>Calories:</strong> <span id="totalCalories">0</span> / <span id="targetCalories">0</span> kcal</p>
        <div class="progress-bar-container">
          <div id="calorieProgress" class="progress-bar green"></div>
        </div>
        <p><strong>Protein:</strong> <span id="totalProtein">0</span>g / <span id="targetProtein">0</span>g</p>
        <div class="progress-bar-container">
          <div id="proteinProgress" class="progress-bar yellow"></div>
        </div>

        <h2>Meal Records</h2>
        <ul id="mealList"></ul>

        <h2>Daily Summary</h2>
        <p id="dailySummary">Awaiting meal entries...</p>
      </section>
    </main>

    <footer>
      <p>Êú¨Êù•„ÅÆÈù¢ÁõÆ, Honrai No Menmoku &copy; 2025</p>
    </footer>

    <script>
document.addEventListener("DOMContentLoaded", function () {
    const storedGoal = localStorage.getItem("goal") || "None";
    const storedTargetCalories = parseInt(localStorage.getItem("targetCalories")) || 2000;
    const storedWeight = parseFloat(localStorage.getItem("weight")) || 70;
    const storedActivityLevel = localStorage.getItem("activity") || "moderate";

    document.getElementById("goalDisplay").innerText = storedGoal;
    document.getElementById("targetCalories").innerText = storedTargetCalories;

    let proteinMultiplier = 1.2;
    if (storedGoal.includes("Cut") || storedGoal.includes("Bulk")) proteinMultiplier = 1.6;
    if (storedActivityLevel === "high") proteinMultiplier = 1.7;

    const targetProtein = Math.round(storedWeight * proteinMultiplier);
    document.getElementById("targetProtein").innerText = targetProtein;

    // ‚úÖ Function to restore progress bar colors after refresh
    function restoreProgressBarColor(barId, defaultColor) {
        const color = localStorage.getItem(`${barId}-color`) || defaultColor;
        document.getElementById(barId).classList.add(color);
    }

    // ‚úÖ Function to set and store progress bar colors
    function setProgressBarColor(barId, color) {
        const progressBar = document.getElementById(barId);
        if (progressBar) {
            progressBar.classList.add(color);
            localStorage.setItem(`${barId}-color`, color); // ‚úÖ Store color in localStorage
        } else {
            console.error(`‚ùå Progress bar with ID ${barId} not found.`);
        }
    }
  
  // ‚úÖ Reset Button Functionality
   document.getElementById("resetDataButton").addEventListener("click", function () {
    console.log("üîÑ Resetting daily meal data...");

    // ‚úÖ Clear only relevant localStorage data
    localStorage.removeItem("mealHistory");
    localStorage.removeItem("totalCalories");
    localStorage.removeItem("totalProtein");
    localStorage.removeItem("dailySummary");

    // ‚úÖ Reset UI elements
    document.getElementById("mealList").innerHTML = "";
    document.getElementById("totalCalories").innerText = "0";
    document.getElementById("totalProtein").innerText = "0";
    document.getElementById("calorieProgress").style.width = "0%";
    document.getElementById("proteinProgress").style.width = "0%";
    document.getElementById("dailySummary").innerText = "Awaiting meal entries...";

    console.log("‚úÖ Daily meal data has been reset!");
});


    updateUIFromStorage();

    document.getElementById("mealForm").addEventListener("submit", async function (event) {
        event.preventDefault();
        const mealInput = document.getElementById("mealInput").value.trim();
        const addMealButton = document.getElementById("addMealButton");

        if (!mealInput) return;

        addMealButton.textContent = "Processing...";
        addMealButton.disabled = true;

        const savedMeals = JSON.parse(localStorage.getItem("mealHistory")) || [];

        try {
            const response = await fetch("/api/analyze-meal", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    meal: mealInput,
                    previousMeals: savedMeals,
                    goal: localStorage.getItem("goal") || "None",
                    targetCalories: parseInt(localStorage.getItem("targetCalories")) || 2000,
                    activityLevel: localStorage.getItem("activity") || "moderate",
                }),
            });

            const result = await response.json();
            console.log("API Response:", result);

            if (result.error) {
                console.error("‚ùå Meal Analysis Failed:", result.error);
                alert("Error analyzing meal. Please try again.");
                return;
            }

            updateMealList(mealInput, result.calories, result.protein);
            updateProgress(result.calories, result.protein, localStorage.getItem("targetCalories"), localStorage.getItem("targetProtein"));

            savedMeals.push({ name: mealInput, calories: result.calories, protein: result.protein });
            localStorage.setItem("mealHistory", JSON.stringify(savedMeals));

            if (result.daily_summary && result.daily_summary.trim() !== "") {
    console.log("üìå Saving daily summary:", result.daily_summary);
    document.getElementById("dailySummary").innerText = result.daily_summary;
    localStorage.setItem("dailySummary", result.daily_summary);
} else {
    console.warn("‚ö†Ô∏è No daily summary received from API.");
    document.getElementById("dailySummary").innerText = "Awaiting meal entries...";
}

            updateUIFromStorage();
        } catch (error) {
            console.error("‚ùå API Request Error:", error);
            alert("An error occurred while analyzing the meal.");
        } finally {
            addMealButton.textContent = "Add Meal";
            addMealButton.disabled = false;
        }
    });

    function updateMealList(meal, calories, protein) {
        const mealList = document.getElementById("mealList");
        const listItem = document.createElement("li");
        listItem.innerHTML = `<strong>${meal}</strong>: ${calories} kcal, ${protein}g protein`;
        mealList.appendChild(listItem);
    }

    function updateProgress(calories, protein, targetCalories, targetProtein) {
        console.log("üîÑ Updating progress bars...");

        const totalCalories = (parseInt(localStorage.getItem("totalCalories")) || 0) + calories;
        const totalProtein = (parseInt(localStorage.getItem("totalProtein")) || 0) + protein;

        document.getElementById("totalCalories").innerText = totalCalories;
        document.getElementById("totalProtein").innerText = totalProtein;

        const caloriePercent = Math.min((totalCalories / targetCalories) * 100, 100);
        const proteinPercent = Math.min((totalProtein / targetProtein) * 100, 100);

        // ‚úÖ Update Progress Bar Widths
        document.getElementById("calorieProgress").style.width = `${caloriePercent}%`;
        document.getElementById("proteinProgress").style.width = `${proteinPercent}%`;

        // ‚úÖ Set Colors
        setProgressBarColor("calorieProgress", "green");
        setProgressBarColor("proteinProgress", "yellow");

        // ‚úÖ Store Values in localStorage
        localStorage.setItem("totalCalories", totalCalories);
        localStorage.setItem("totalProtein", totalProtein);
    }

    function updateUIFromStorage() {
        console.log("üîÑ Restoring UI from localStorage...");

        document.getElementById("mealList").innerHTML = "";

        const meals = JSON.parse(localStorage.getItem("mealHistory")) || [];
        meals.forEach(meal => updateMealList(meal.name, meal.calories, meal.protein));

        const totalCalories = parseInt(localStorage.getItem("totalCalories")) || 0;
        const totalProtein = parseInt(localStorage.getItem("totalProtein")) || 0;
        const targetCalories = parseInt(localStorage.getItem("targetCalories")) || 2000;
        const targetProtein = parseInt(localStorage.getItem("targetProtein")) || 100;

        document.getElementById("totalCalories").innerText = totalCalories;
        document.getElementById("totalProtein").innerText = totalProtein;

        // ‚úÖ Restore Progress Bar Widths
        document.getElementById("calorieProgress").style.width = `${Math.min((totalCalories / targetCalories) * 100, 100)}%`;
        document.getElementById("proteinProgress").style.width = `${Math.min((totalProtein / targetProtein) * 100, 100)}%`;

        // ‚úÖ Restore Progress Bar Colors
        restoreProgressBarColor("calorieProgress", "green");
        restoreProgressBarColor("proteinProgress", "yellow");

        // ‚úÖ Restore Daily Summary
        const dailySummary = localStorage.getItem("dailySummary") || "Awaiting meal entries...";
        document.getElementById("dailySummary").innerText = dailySummary;

        console.log("‚úÖ UI restored from localStorage!");
    }

}); // ‚úÖ Closes DOMContentLoaded event listener

    </script>
  </body>
</html>
